# --- Этап 1: Сборка (Builder) ---
# Используем официальный образ Go с Alpine Linux для сборки приложения.
# Называем этот этап 'builder', чтобы ссылаться на него позже.
FROM golang:1.21-alpine AS builder

# Устанавливаем рабочую директорию внутри контейнера
WORKDIR /app

# Копируем файлы управления зависимостями и скачиваем их.
# Это кэшируется Docker, поэтому зависимости не будут скачиваться каждый раз.
COPY go.mod go.sum ./
RUN go mod download

# Копируем весь остальной исходный код
COPY . .

# Компилируем Go-приложение в статический бинарник без зависимостей от C.
# Флаг -o main указывает имя выходного файла.
RUN CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o main .

# --- Этап 2: Финальный образ ---
# Используем легковесный образ Alpine Linux.
# Он будет содержать только скомпилированное приложение.
FROM alpine:latest

# Устанавливаем рабочую директорию
WORKDIR /root/

# Копируем скомпилированный бинарник с этапа 'builder'
COPY --from=builder /app/main .

# Копируем наш HTML-файл с этапа 'builder'
COPY --from=builder /app/index.html .

# Сообщаем Docker, что контейнер будет слушать порт 8080
# Это для документации, не открывает порт наружу.
EXPOSE 8080

# Команда, которая запустит наш веб-сервер при старте контейнера
CMD ["./main"]
